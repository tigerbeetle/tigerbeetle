name: Clients

concurrency:
  group: clients-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  workflow_call:

jobs:
  client-java:
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix:
        # os: [ubuntu-latest-large, windows-latest-large, macos-13,  macos-13-xlarge]
        os: [ubuntu-latest]
        java-version: ['11', '17', '18', '19', '20', '20', '20', '21', '21', '21']

    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      # Maven is pre-installed on GHA runners, but it is **not** installed by `setup-java` action,
      # so it is missing on self-hosted runners. Install manually.
      - run: |
          curl -o maven.zip https://archive.apache.org/dist/maven/maven-3/3.9.3/binaries/apache-maven-3.9.3-bin.zip
          unzip maven.zip
      -  if: matrix.os != 'windows-latest-large'
         run: echo "$GITHUB_WORKSPACE/apache-maven-3.9.3/bin" >> $GITHUB_PATH
      -  if: matrix.os == 'windows-latest-large'
         run: '"$env:GITHUB_WORKSPACE/apache-maven-3.9.3/bin" | Out-File -FilePath $env:GITHUB_PATH -Append'

      - run: ./scripts/install_zig.${{ matrix.os == 'windows-latest-large' && 'bat' || 'sh' }}
      - run: ./zig/zig build ci -- --language=java
      # - run: ./zig/zig build client_docs -- --language=java
      # - if: matrix.os == 'ubuntu-latest-large'
        # run: ./.github/ci/fail_on_diff.sh

  clients-pipeline:
    needs:
      - client-java

    runs-on: ubuntu-latest
    steps:
      - name: All Client CI Jobs Passed
        working-directory: ./
        run: exit 0
